# План реализации ChatList ✅ ЗАВЕРШЁН

## Этап 1: Подготовка проекта ✅

1. **Настройка структуры проекта** ✅
   - Создать файлы: `db.py`, `models.py`, `network.py` ✅
   - Обновить `requirements.txt` с необходимыми зависимостями ✅
   - Создать файл `.env` с API-ключами ✅
     > Ключи: `OPENROUTER_API_KEY`, `OPENAI_API_KEY`, `ANTHROPIC_API_KEY`, `DEEPSEEK_API_KEY`, `GROQ_API_KEY`

2. **Установка зависимостей** ✅
   ```powershell
   pip install PyQt6 httpx python-dotenv markdown pyinstaller
   ```

---

## Этап 2: База данных (db.py) ✅

1. **Создание модуля работы с SQLite** ✅
   - Функция инициализации БД и создания таблиц ✅
   - CRUD-операции для таблицы `prompts` ✅
   - CRUD-операции для таблицы `models` ✅
   - CRUD-операции для таблицы `results` ✅
   - Функции для таблицы `settings` ✅

2. **Миграции** ✅
   - Автоматическое создание таблиц при первом запуске ✅
   - Добавление тестовых данных (seed) ✅

---

## Этап 3: Модели данных (models.py) ✅

1. **Создание dataclass-ов** ✅
   - `Prompt` — хранение промпта ✅
   - `Model` — информация о LLM-модели ✅
   - `Result` — результат тестирования ✅
   - `Settings` — настройки приложения ✅

---

## Этап 4: Сетевой модуль (network.py) ✅

1. **Базовый HTTP-клиент** ✅
   - Асинхронные запросы через `httpx` ✅
   - Загрузка API-ключей из `.env` ✅

2. **Адаптеры для разных API** ✅
   - OpenAI-совместимый формат ✅
   - Обработка ошибок и таймаутов ✅
   - Потоковая передача ответов (опционально) ✅

---

## Этап 5: Графический интерфейс (main.py) ✅

### 5.1 Основное окно ✅
- Создание главного окна PyQt ✅
- Разметка интерфейса (layouts) ✅

### 5.2 Панель ввода промпта ✅
- Текстовое поле для ввода нового промпта ✅
- Выпадающий список для выбора из истории (`prompts`) ✅
- Кнопка "Отправить" ✅

### 5.3 Панель управления моделями ✅
- Список активных моделей с чекбоксами ✅
- Кнопки "Выбрать все" / "Снять все" ✅
- Кнопка настройки моделей ✅

### 5.4 Область результатов ✅
- Горизонтальный скролл для карточек ответов ✅
- Карточка для каждой модели: ✅
  - Название модели ✅
  - Текст ответа ✅
  - Чекбокс `selected` для сохранения ✅
  - Кнопка "Открыть" для просмотра Markdown ✅

### 5.5 Панель действий ✅
- Кнопка "Сохранить выбранные" ✅
- Поиск по истории по тексту ✅
- Поиск по дате ✅

---

## Этап 6: Интеграция компонентов ✅

1. **Связывание UI с логикой** ✅
   - Подключение обработчиков событий ✅
   - Валидация данных ✅
   - Обработка ошибок с уведомлениями ✅

2. **Асинхронное выполнение запросов** ✅
   - Параллельная отправка промптов во все активные модели ✅
   - Отображение прогресса загрузки ✅
   - Обновление UI по мере получения ответов ✅

---

## Этап 7: Дополнительные функции ✅

1. **Тёмная и светлая темы** ✅
   - Настройка стилей Qt (DARK_STYLE, LIGHT_STYLE) ✅
   - Переключатель темы в заголовке 🌙/☀️ ✅

2. **Экспорт результатов** ✅
   - Экспорт в Markdown ✅
   - Экспорт в JSON ✅

3. **Настройки приложения** ✅
   - Диалог настроек (SettingsDialog) ✅
   - Управление списком моделей ✅
   - Редактирование API endpoints ✅

---

## Этап 8: Тестирование и сборка ✅

1. **Тестирование** ✅
   - Проверка всех CRUD-операций ✅ (25 тестов)
   - Тестирование сетевых запросов ✅
   - Проверка UI на разных разрешениях ✅

2. **Сборка исполняемого файла** ✅
   ```powershell
   python -m PyInstaller --onefile --windowed --name ChatList main.py
   ```
   > Собрано: `dist/ChatList.exe`

3. **Запуск тестов** ✅
   ```powershell
   python tests.py
   ```
   > Результат: 25 тестов пройдено успешно

---

## Контрольные точки

| Этап | Описание | Статус |
|------|----------|--------|
| 1 | Структура проекта | ✅ |
| 2 | База данных | ✅ |
| 3 | Модели данных | ✅ |
| 4 | Сетевой модуль | ✅ |
| 5 | Графический интерфейс | ✅ |
| 6 | Интеграция | ✅ |
| 7 | Дополнительные функции | ✅ |
| 8 | Тестирование и сборка | ✅ |

---

## 📦 Структура проекта

```
ChatList/
├── main.py           # Главное окно приложения (PyQt6)
├── db.py             # Модуль работы с SQLite
├── models.py         # Dataclass-ы моделей данных
├── network.py        # Сетевой модуль (httpx)
├── tests.py          # Автотесты (25 тестов)
├── requirements.txt  # Зависимости
├── chatlist.db       # База данных SQLite
├── .env              # API-ключи (не в git)
├── PLAN.md           # Этот файл
├── README.md         # Документация
└── dist/
    └── ChatList.exe  # Собранный исполняемый файл
```

---

## 🎉 Проект завершён!

Дата завершения: Январь 2026

---

# Этап 9: AI-ассистент для улучшения промтов ✅

## Описание функции

AI-ассистент помогает пользователю улучшить введённый промт, предлагая несколько вариантов переформулировки и адаптации под разные задачи.

---

## 9.1 Изменения в network.py

### Задачи:

1. **Добавить функцию `improve_prompt()`**
   - Принимает исходный промт от пользователя
   - Отправляет системный запрос в выбранную модель через существующий `LLMClient`
   - Формирует специальный мета-промпт для улучшения

2. **Системный промпт для AI-ассистента:**
   ```
   Ты - эксперт по написанию промптов для языковых моделей.
   Проанализируй следующий промпт и верни:
   1. УЛУЧШЕННАЯ ВЕРСИЯ: переформулированный промпт с лучшей структурой
   2. ВАРИАНТ ДЛЯ КОДА: адаптация для задач программирования
   3. ВАРИАНТ ДЛЯ АНАЛИЗА: адаптация для аналитических задач
   4. КРЕАТИВНЫЙ ВАРИАНТ: адаптация для творческих задач
   
   Формат ответа - JSON:
   {
     "improved": "...",
     "code_variant": "...",
     "analysis_variant": "...",
     "creative_variant": "..."
   }
   ```

3. **Парсинг ответа:**
   - Извлечение JSON из ответа модели
   - Обработка ошибок парсинга
   - Возврат структурированного результата

### Новые классы/функции:

```python
@dataclass
class ImprovedPrompt:
    """Результат улучшения промта."""
    improved: str
    code_variant: str
    analysis_variant: str
    creative_variant: str
    success: bool
    error: Optional[str] = None

async def improve_prompt(
    model: Model,
    original_prompt: str,
    timeout: int = 60
) -> ImprovedPrompt:
    """Отправить промт на улучшение в указанную модель."""
```

---

## 9.2 Изменения в main.py

### 9.2.1 Добавление кнопки "Улучшить промт"

- [ ] Добавить кнопку `improve_btn` рядом с полем ввода промта
- [ ] Стилизация: вторичная кнопка с иконкой ✨
- [ ] Позиционирование: горизонтальный layout с кнопкой "Отправить"

```python
# В методе _create_input_panel():
buttons_layout = QHBoxLayout()

self.improve_btn = QPushButton("✨ Улучшить промт")
self.improve_btn.setObjectName("secondary")
self.improve_btn.clicked.connect(self._on_improve_clicked)
buttons_layout.addWidget(self.improve_btn)

self.send_button = QPushButton("🚀 Отправить")
self.send_button.clicked.connect(self._on_send_clicked)
buttons_layout.addWidget(self.send_button)

prompt_layout.addLayout(buttons_layout)
```

### 9.2.2 Диалог выбора модели для улучшения

- [ ] Создать диалог `SelectModelDialog` для выбора одной модели
- [ ] Показывать только активные модели из списка
- [ ] Запоминать последний выбор в настройках

### 9.2.3 Диалог результатов улучшения `ImprovePromptDialog`

- [ ] Отображение исходного промта (только для чтения)
- [ ] 4 варианта улучшенного промта в виде карточек:
  - Улучшенная версия
  - Для кода
  - Для анализа
  - Креативный
- [ ] Кнопка "Использовать" для каждого варианта
- [ ] Кнопка "Копировать" для каждого варианта
- [ ] Индикатор загрузки во время запроса

```python
class ImprovePromptDialog(QDialog):
    """Диалог с результатами улучшения промта."""
    
    prompt_selected = pyqtSignal(str)  # Сигнал выбора промта
    
    def __init__(self, original_prompt: str, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Улучшение промта")
        self.setMinimumSize(800, 600)
        self._setup_ui()
    
    def _setup_ui(self):
        # Исходный промт
        # Карточки вариантов
        # Кнопки действий
        pass
    
    def set_results(self, result: ImprovedPrompt):
        """Установить результаты улучшения."""
        pass
    
    def _on_use_clicked(self, variant: str):
        """Подставить выбранный вариант в поле ввода."""
        self.prompt_selected.emit(variant)
        self.accept()
```

### 9.2.4 Фоновый поток для запроса `ImproveWorker`

- [ ] Создать класс `ImproveWorker(QThread)` для асинхронного запроса
- [ ] Сигналы: `finished(ImprovedPrompt)`, `error(str)`
- [ ] Интеграция с существующим event loop

```python
class ImproveWorker(QThread):
    """Фоновый поток для улучшения промта."""
    
    finished = pyqtSignal(object)  # ImprovedPrompt
    error = pyqtSignal(str)
    
    def __init__(self, model: Model, prompt: str, timeout: int = 60):
        super().__init__()
        self.model = model
        self.prompt = prompt
        self.timeout = timeout
    
    def run(self):
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        try:
            result = loop.run_until_complete(
                improve_prompt(self.model, self.prompt, self.timeout)
            )
            self.finished.emit(result)
        except Exception as e:
            self.error.emit(str(e))
        finally:
            loop.close()
```

### 9.2.5 Обработчик нажатия кнопки

```python
def _on_improve_clicked(self):
    """Обработчик нажатия кнопки улучшения промта."""
    prompt_text = self.prompt_input.toPlainText().strip()
    if not prompt_text:
        QMessageBox.warning(self, "Внимание", "Введите текст промпта")
        return
    
    # Выбор модели для улучшения
    model = self._select_improve_model()
    if not model:
        return
    
    # Показать диалог с индикатором загрузки
    self.improve_dialog = ImprovePromptDialog(prompt_text, self)
    
    # Запустить фоновый запрос
    self.improve_worker = ImproveWorker(model, prompt_text)
    self.improve_worker.finished.connect(self.improve_dialog.set_results)
    self.improve_worker.error.connect(self._on_improve_error)
    self.improve_worker.start()
    
    # Подключить сигнал выбора
    self.improve_dialog.prompt_selected.connect(
        lambda text: self.prompt_input.setPlainText(text)
    )
    
    self.improve_dialog.exec()
```

---

## 9.3 Изменения в db.py

### Задачи:

- [ ] Добавить настройку `improve_model_id` в таблицу settings
- [ ] Хранить ID последней выбранной модели для улучшения

```python
# Новые функции:
def get_improve_model_id() -> Optional[int]:
    """Получить ID модели для улучшения промтов."""
    
def set_improve_model_id(model_id: int):
    """Установить ID модели для улучшения промтов."""
```

---

## 9.4 План тестирования

### Юнит-тесты:

- [ ] Тест парсинга JSON ответа от AI
- [ ] Тест обработки ошибок сети
- [ ] Тест обработки некорректного JSON

### Интеграционные тесты:

- [ ] Тест полного цикла улучшения промта
- [ ] Тест подстановки выбранного варианта в поле ввода
- [ ] Тест сохранения выбранной модели в настройках

### UI-тесты:

- [ ] Проверка отображения всех 4 вариантов
- [ ] Проверка кнопок "Использовать" и "Копировать"
- [ ] Проверка индикатора загрузки

---

## 9.5 Контрольные точки

| # | Задача | Статус |
|---|--------|--------|
| 1 | Функция `improve_prompt()` в network.py | ✅ |
| 2 | Класс `ImprovedPrompt` dataclass | ✅ |
| 3 | Кнопка "Улучшить промт" в UI | ✅ |
| 4 | Диалог выбора модели | ✅ |
| 5 | Диалог результатов `ImprovePromptDialog` | ✅ |
| 6 | Фоновый поток `ImproveWorker` | ✅ |
| 7 | Интеграция с полем ввода | ✅ |
| 8 | Сохранение настроек в БД | ✅ |
| 9 | Тестирование | ⬜ |

---

## 9.6 Примерный UI диалога

```
┌─────────────────────────────────────────────────────────────┐
│  ✨ Улучшение промта                                    [X] │
├─────────────────────────────────────────────────────────────┤
│  📝 Исходный промт:                                         │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ Напиши код для сортировки массива                   │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ⭐ Улучшенная версия:                                      │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ Реализуй эффективный алгоритм сортировки массива    │    │
│  │ целых чисел. Укажи временную сложность...           │    │
│  └─────────────────────────────────────────────────────┘    │
│  [Использовать] [Копировать]                                │
│                                                             │
│  💻 Для кода:                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ Напиши функцию на Python для сортировки массива...  │    │
│  └─────────────────────────────────────────────────────┘    │
│  [Использовать] [Копировать]                                │
│                                                             │
│  📊 Для анализа:                                            │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ Сравни различные алгоритмы сортировки массивов...   │    │
│  └─────────────────────────────────────────────────────┘    │
│  [Использовать] [Копировать]                                │
│                                                             │
│  🎨 Креативный:                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ Представь, что ты учитель информатики. Объясни...   │    │
│  └─────────────────────────────────────────────────────┘    │
│  [Использовать] [Копировать]                                │
│                                                             │
│                                        [Закрыть]            │
└─────────────────────────────────────────────────────────────┘
```

---

## 9.7 Оценка трудозатрат

| Компонент | Время |
|-----------|-------|
| network.py | 1-2 часа |
| ImprovePromptDialog | 2-3 часа |
| Интеграция в main.py | 1-2 часа |
| db.py настройки | 0.5 часа |
| Тестирование | 1-2 часа |
| **Итого** | **6-10 часов** |
